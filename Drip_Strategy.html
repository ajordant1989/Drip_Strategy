<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIP Strategy Calculator & Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="global.css">
    <style>

    </style>
</head>

<body>
    <div class="container">
        <h1>DRIP Strategy Calculator & Tracker</h1>
        <div class="results full-width" id="results" style="display: flex;">
            <div class="result-card">
                <h3>Blended Yield</h3>
                <div class="value" id="blendedYield">0%</div>
            </div>
            <div class="result-card">
                <h3>Weekly Income</h3>
                <div class="value" id="weeklyIncome">$0</div>
            </div>
            <div class="result-card">
                <h3>Annual Income</h3>
                <div class="value" id="annualIncome">$0</div>
            </div>
            <div class="result-card">
                <h3>Time to Target</h3>
                <div class="value" id="timeToTarget">0 months</div>
            </div>
        </div>

        <section class="full-width" style="margin-bottom: 16px;">
            <div class="card portfolio-setup">
                <h2>ðŸ“Š Portfolio Setup</h2>
                <div class="input-group">
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="totalInvestment" style="display: flex; align-items: center;">
                            Starting Invesment
                            <span class="tooltip-icon" tabindex="0" style="margin-left: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#FFFFFF" />
                                    <text x="12" y="16" text-anchor="middle" font-size="16" fill="#000"
                                        font-family="Inter, Arial" font-weight="bold">?</text>
                                </svg>
                                <span class="tooltip-text">
                                    Amount you plan to add to your ETFs
                                </span>
                            </span>
                        </label>
                        <div class="input-row">
                            <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                            <input type="text" id="totalInvestment" step="100" min="0" placeholder="0"
                                class="with-unit input-no-border" data-unit="$">
                            <div class="input-arrows">
                                <svg class="input-arrow" onclick="stepInput('totalInvestment', 100)"
                                    viewBox="0 0 24 24">
                                    <path d="M12 8l-6 6h12z" />
                                </svg>
                                <svg class="input-arrow" onclick="stepInput('totalInvestment', -100)"
                                    viewBox="0 0 24 24">
                                    <path d="M12 16l6-6H6z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="targetAmount" style="display: flex; align-items: center;">
                            Target Amount
                            <span class="tooltip-icon" tabindex="0" style="margin-left: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#FFFFFF" />
                                    <text x="12" y="16" text-anchor="middle" font-size="16" fill="#000"
                                        font-family="Inter, Arial" font-weight="bold">?</text>
                                </svg>
                                <span class="tooltip-text">
                                    This is your goal amount you wish to make from this strategy
                                </span>
                            </span>
                        </label>
                        <div class="input-row">
                            <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                            <input type="text" id="targetAmount" step="100" min="0" placeholder="0"
                                class="with-unit input-no-border">
                            <div class="input-arrows">
                                <svg class="input-arrow" onclick="stepInput('targetAmount', 100)" viewBox="0 0 24 24">
                                    <path d="M12 8l-6 6h12z" />
                                </svg>
                                <svg class="input-arrow" onclick="stepInput('targetAmount', -100)" viewBox="0 0 24 24">
                                    <path d="M12 16l6-6H6z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="distributionFreq" style="display: flex; align-items: center;">
                            Distribution Frequency
                            <span class="tooltip-icon" tabindex="0" style="margin-left: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#FFFFFF" />
                                    <text x="12" y="16" text-anchor="middle" font-size="16" fill="#000"
                                        font-family="Inter, Arial" font-weight="bold">?</text>
                                </svg>
                                <span class="tooltip-text">
                                    This is the frequency of how often your adding additional money into your IUL
                                </span>
                            </span>
                        </label>
                        <div class="input-row">
                            <select id="distributionFreq"
                                style="flex:1; background: transparent; border: none; color: #fff; font-size: 1.15rem; font-weight: 500; height: 56px; outline: none;"
                                class="input-no-border">
                                <option value="52">Weekly (52x/year)</option>
                                <option value="26">Bi-weekly (26x/year)</option>
                                <option value="12" selected>Monthly (12x/year)</option>
                                <option value="4">Quarterly (4x/year)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-green" onclick="calculateResults()">Calculate Strategy</button>
                    <button class="projection-btn" onclick="scrollToProjection()">See Growth Chart</button>
                </div>
            </div>
        </section>

        <section class="full-width" style="margin-bottom: 16px;">
            <div class="card portfolio-positions">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <h2 style="margin: 0;">ðŸ“ˆ Portfolio Positions</h2>
                    <button class="add-position-text-btn" onclick="openAddPositionModal()" type="button">+ Add New
                        Position
                    </button>
                </div>
                <div id="allocationError" class="error-message" style="display: none;"></div>
                <table class="portfolio-table" id="portfolioTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Allocation %</th>
                            <th>Amount</th>
                            <th>Yield %</th>
                            <th>Annual Income</th>
                            <th>Weekly Income</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Integration Grid Toggle Switch -->
        <div style="width:100%; display:flex; justify-content:flex-end; margin-bottom:16px;">
            <label class="toggle-switch" id="integrationToggleLabel">
                <input type="checkbox" id="toggleIntegrationGridSwitch" checked>
                <span class="slider"></span>
            </label>
            <span id="toggleIntegrationGridText"
                style="margin-left:12px; color:#fff; font-weight:500; font-size:1rem;">Hide Integrations</span>
        </div>

        <div id="integrationGridContainer" style="width: 100%;">
            <div class="integration-grid" style="display: flex; gap: 32px; width: 100;">
                <div class="card iul-integration">
                    <h2>ðŸ’° IUL Integration</h2>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulPremium">Monthly IUL Premium</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="number" id="iulPremium" step="50" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('iulPremium', 50)" viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('iulPremium', -50)" viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulCashValue">Current Cash Value</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="iulCashValue" step="100" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('iulCashValue', 100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('iulCashValue', -100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulGrowthRate">Expected Growth Rate</label>
                            <div class="input-row">
                                <input type="number" id="iulGrowthRate" step="0.5" min="0" placeholder="0"
                                    class="with-unit">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('iulGrowthRate', 0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('iulGrowthRate', -0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="reinvestToIUL">Reinvest % to IUL</label>
                            <div class="input-row">
                                <input type="number" id="reinvestToIUL" step="5" min="0" max="100" placeholder="0"
                                    class="with-unit">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('reinvestToIUL', 5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('reinvestToIUL', -5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bitcoin-integration">
                    <h2>â‚¿ Bitcoin Integration</h2>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinAmountBTC">Current Bitcoin Amount (BTC)</label>
                            <div class="input-row">
                                <input type="number" id="bitcoinAmountBTC" step="0.001" min="0" placeholder="0"
                                    class="with-unit input-no-border" data-unit="BTC">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinAmountBTC', 0.001)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinAmountBTC', -0.001)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinPriceUSD">Current Bitcoin Price</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="bitcoinPriceUSD" step="100" min="0" placeholder="0"
                                    class="with-unit input-no-border" data-unit="$">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinPriceUSD', 100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinPriceUSD', -100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinCAGR">Bitcoin CAGR (%)</label>
                            <div class="input-row">
                                <input type="number" id="bitcoinCAGR" step="0.5" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinCAGR', 0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinCAGR', -0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinMonthlySavingsUSD">Monthly Bitcoin Savings</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="number" id="bitcoinMonthlySavingsUSD" step="1" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinMonthlySavingsUSD', 1)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinMonthlySavingsUSD', -1)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="reinvestToBitcoin">Reinvest % to Bitcoin</label>
                            <div class="input-row">
                                <input type="number" id="reinvestToBitcoin" step="5" min="0" max="100" placeholder="0"
                                    class="with-unit input-no-border">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('reinvestToBitcoin', 5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('reinvestToBitcoin', -5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="projection-chart" id="projectionChartContainer"
            style="height: 500px; width: 100%; max-width: 1280px;">
            <h2>ðŸ“Š Monthly Growth Projection</h2>
            <canvas id="wealthChart" style="margin-bottom: 16px; height: 400px; width: 100%;"></canvas>
            <div class="table-scroll">
                <table class="projection-table" id="projectionTable" style="width: 100%; max-width: 1280px;">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Portfolio Value</th>
                            <th>Monthly Income</th>
                            <th>IUL Value</th>
                            <th>Bitcoin Value</th>
                            <th>Total Wealth</th>
                        </tr>
                    </thead>
                    <tbody id="projectionBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="addPositionModal">
        <div class="modal-content">
            <h3>Add New Position</h3>
            <div class="input-group">
                <div style="display: flex; flex-direction: column;">
                    <label for="modalTicker">Ticker Symbol</label>
                    <input type="text" id="modalTicker" placeholder="e.g., AAPL" class="input-row">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="modalAllocation">Allocation (%)</label>
                    <input type="number" id="modalAllocation" step="0.1" min="0" placeholder="e.g., 25"
                        class="input-row">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="modalYield">Yield (%)</label>
                    <input type="number" id="modalYield" step="0.1" min="0" placeholder="e.g., 5" class="input-row">
                </div>
            </div>
            <div id="modalError" class="error-message" style="display: none;"></div>
            <button class="btn" onclick="submitNewPosition()">Add Position</button>
            <button class="close-btn" onclick="closeAddPositionModal()">Cancel</button>
        </div>
    </div>

    <script>
        let positions = [];
        let positionCounter = 0;
        let wealthChart = null;
        let editingPositionId = null; // Track which position is being edited

        // Save all inputs and positions to localStorage
        function saveState() {
            const inputs = [
                'totalInvestment', 'targetAmount', 'distributionFreq',
                'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL',
                'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin'
            ];
            const state = {};
            inputs.forEach(id => {
                const el = document.getElementById(id);
                // Save raw value without commas
                state[id] = el ? el.value.replace(/,/g, '') : '';
            });
            state.positions = positions;
            localStorage.setItem('dripStrategyState', JSON.stringify(state));
        }

        // Restore all inputs and positions from localStorage
        function restoreState() {
            const state = JSON.parse(localStorage.getItem('dripStrategyState') || '{}');
            const inputs = [
                'totalInvestment', 'targetAmount', 'distributionFreq',
                'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL',
                'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin'
            ];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el && state[id] !== undefined) {
                    // Format with commas for display if it's a number or can be parsed as a number
                    if (el.type === 'number') {
                        el.value = state[id];
                    } else {
                        // Try to format as number if possible
                        if (state[id] !== '' && !isNaN(state[id])) {
                            el.value = Number(state[id]).toLocaleString('en-US');
                        } else {
                            el.value = state[id];
                        }
                    }
                }
            });
            if (Array.isArray(state.positions)) {
                positions = state.positions;
                positionCounter = positions.length > 0 ? Math.max(...positions.map(p => p.id)) + 1 : 0;
            }
            updatePortfolioDisplay();
        }

        // Initialize with no default positions
        function initializeDefaultPositions() {
            positions = [];
            positionCounter = 0;
            updatePortfolioDisplay();
        }

        function openAddPositionModal(editId = null) {
            document.getElementById('addPositionModal').style.display = 'flex';
            document.getElementById('modalError').style.display = 'none';
            editingPositionId = editId;

            if (editId !== null) {
                // Editing existing position
                const pos = positions.find(p => p.id === editId);
                if (pos) {
                    document.getElementById('modalTicker').value = pos.ticker;
                    document.getElementById('modalAllocation').value = pos.allocation;
                    document.getElementById('modalYield').value = pos.yield;
                }
            } else {
                // Adding new position
                document.getElementById('modalTicker').value = '';
                document.getElementById('modalAllocation').value = '';
                document.getElementById('modalYield').value = '';
            }
        }

        function closeAddPositionModal() {
            document.getElementById('addPositionModal').style.display = 'none';
        }

        function submitNewPosition() {
            const ticker = document.getElementById('modalTicker').value.trim().toUpperCase();
            const allocation = parseFloat(document.getElementById('modalAllocation').value);
            const yieldRate = parseFloat(document.getElementById('modalYield').value);

            if (!ticker || isNaN(allocation) || isNaN(yieldRate) || allocation <= 0 || yieldRate < 0) {
                document.getElementById('modalError').textContent = 'Please enter valid values for all fields.';
                document.getElementById('modalError').style.display = 'block';
                return;
            }

            // If editing, update the position
            if (editingPositionId !== null) {
                const pos = positions.find(p => p.id === editingPositionId);
                if (pos) {
                    pos.ticker = ticker;
                    pos.allocation = allocation;
                    pos.yield = yieldRate;
                }
                editingPositionId = null;
            } else {
                // Adding new position
                const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0) + allocation;
                if (totalAllocation > 100) {
                    document.getElementById('modalError').textContent = 'Total allocation exceeds 100%.';
                    document.getElementById('modalError').style.display = 'block';
                    return;
                }
                positions.push({
                    id: positionCounter++,
                    ticker: ticker,
                    allocation: allocation,
                    yield: yieldRate
                });
            }
            saveState();
            updatePortfolioDisplay();
            closeAddPositionModal();
        }

        function removePosition(id) {
            positions = positions.filter(pos => pos.id !== id);
            saveState();
            updatePortfolioDisplay();
        }

        function updatePortfolioDisplay() {
            const tbody = document.getElementById('portfolioBody');
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);

            // Get distribution frequency and label
            const freqSelect = document.getElementById('distributionFreq');
            const freqValue = parseInt(freqSelect.value, 10);
            let freqLabel = 'Weekly Income';
            if (freqValue === 52) freqLabel = 'Weekly Income';
            else if (freqValue === 26) freqLabel = 'Bi-weekly Income';
            else if (freqValue === 12) freqLabel = 'Monthly Income';
            else if (freqValue === 4) freqLabel = 'Quarterly Income';

            // Update table header
            const ths = document.querySelectorAll('#portfolioTable thead th');
            if (ths.length >= 6) {
                ths[5].textContent = freqLabel;
            }

            const allocationError = document.getElementById('allocationError');
            if (totalAllocation > 100) {
                allocationError.textContent = `Total allocation (${totalAllocation.toFixed(1)}%) exceeds 100%. Please adjust.`;
                allocationError.style.display = 'block';
            } else {
                allocationError.style.display = 'none';
            }

            tbody.innerHTML = '';

            positions.forEach(position => {
                const amount = (totalInvestment * position.allocation / 100);
                const annualIncome = (amount * position.yield / 100);

                // Calculate income based on frequency
                let freqIncome = annualIncome / freqValue;
                if (freqValue === 4) freqIncome = annualIncome / 4; // Quarterly
                else if (freqValue === 12) freqIncome = annualIncome / 12; // Monthly
                else if (freqValue === 26) freqIncome = annualIncome / 26; // Bi-weekly
                else if (freqValue === 52) freqIncome = annualIncome / 52; // Weekly

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${position.ticker}</td>
                    <td>${position.allocation}%</td>
                    <td>$${amount.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>${position.yield}%</td>
                    <td>$${annualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${freqIncome.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
                    <td>
                        <button class="edit-btn" onclick="openAddPositionModal(${position.id})">Edit</button>
                        <button class="remove-btn" onclick="removePosition(${position.id})">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateResults() {
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value.replace(/,/g, '')) || 0;
            const reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
            const reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;

            if (totalInvestment <= 0 || targetAmount <= 0) {
                alert('Total Investment and Target Amount must be greater than 0.');
                return;
            }
            if (positions.length === 0) {
                alert('Please add at least one position.');
                return;
            }
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            if (totalAllocation > 100) {
                alert('Total allocation exceeds 100%. Please adjust.');
                return;
            }
            if (reinvestToIUL + reinvestToBitcoin > 100) {
                alert('The sum of reinvestment percentages for IUL and Bitcoin cannot exceed 100%.');
                return;
            }

            let totalWeightedYield = 0;
            positions.forEach(position => {
                totalWeightedYield += position.allocation * position.yield;
            });

            const blendedYield = totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;
            const annualIncome = totalInvestment * blendedYield / 100;
            const weeklyIncome = annualIncome / 52;

            const projectionResults = generateAndRenderProjections();

            document.getElementById('blendedYield').textContent = blendedYield.toFixed(2) + '%';
            document.getElementById('weeklyIncome').textContent = '$' + weeklyIncome.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('annualIncome').textContent = '$' + annualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 });
            document.getElementById('timeToTarget').textContent = projectionResults.timeToTarget !== 'N/A' ? `${projectionResults.timeToTarget} months` : 'N/A';

            // FIX: Do not change display style here!
            // Remove or comment out this line:
            // document.getElementById('results').style.display = 'grid';

            document.getElementById('projectionChartContainer').style.display = 'block';

            renderChart(projectionResults.chartData);
        }

        function generateAndRenderProjections() {
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value.replace(/,/g, '')) || 0;
            const iulPremium = parseFloat(document.getElementById('iulPremium').value.replace(/,/g, '')) || 0;
            const iulCashValue = parseFloat(document.getElementById('iulCashValue').value.replace(/,/g, '')) || 0;
            const iulGrowthRate = parseFloat(document.getElementById('iulGrowthRate').value) || 0;
            const reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
            const bitcoinAmountBTC = parseFloat(document.getElementById('bitcoinAmountBTC').value) || 0;
            const initialBitcoinPriceUSD = parseFloat(document.getElementById('bitcoinPriceUSD').value.replace(/,/g, '')) || 60000;
            const bitcoinCAGR = parseFloat(document.getElementById('bitcoinCAGR').value) || 0;
            const bitcoinMonthlySavingsUSD = parseFloat(document.getElementById('bitcoinMonthlySavingsUSD').value.replace(/,/g, '')) || 0;
            const reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;

            let totalWeightedYield = 0;
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            positions.forEach(position => {
                totalWeightedYield += position.allocation * position.yield;
            });
            const blendedYield = totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;

            const monthlyYield = blendedYield / 100 / 12;
            const monthlyIULGrowth = iulGrowthRate / 100 / 12;
            const monthlyBitcoinGrowth = Math.pow(1 + bitcoinCAGR / 100, 1 / 12) - 1;

            let portfolioValue = totalInvestment;
            let currentIULValue = iulCashValue;
            let currentBitcoinAmountBTC = bitcoinAmountBTC;
            let currentBitcoinPriceUSD = initialBitcoinPriceUSD;

            const tbody = document.getElementById('projectionBody');
            tbody.innerHTML = '';

            const chartData = { labels: [], portfolio: [], iul: [], bitcoin: [], total: [] };
            let timeToTarget = 'N/A';
            let targetReached = false;

            for (let month = 0; month <= 600; month++) { // Calculate for up to 50 years
                const monthlyIncome = portfolioValue * monthlyYield;
                const toIUL = monthlyIncome * (reinvestToIUL / 100);
                const toBitcoin = monthlyIncome * (reinvestToBitcoin / 100);
                const toDRIP = monthlyIncome - toIUL - toBitcoin;

                if (month > 0) {
                    portfolioValue += toDRIP;

                    currentIULValue += toIUL + iulPremium;
                    currentIULValue *= (1 + monthlyIULGrowth);

                    const btcFromSavings = bitcoinMonthlySavingsUSD / currentBitcoinPriceUSD;
                    const btcFromReinvest = toBitcoin / currentBitcoinPriceUSD;
                    currentBitcoinAmountBTC += btcFromSavings + btcFromReinvest;

                    currentBitcoinPriceUSD *= (1 + monthlyBitcoinGrowth);
                }

                const currentBitcoinValueUSD = currentBitcoinAmountBTC * currentBitcoinPriceUSD;
                const totalWealth = portfolioValue + currentIULValue + currentBitcoinValueUSD;

                if (totalWealth >= targetAmount && timeToTarget === 'N/A') {
                    timeToTarget = month;
                    targetReached = true;
                }

                // Only render up to 48 months in the monthly table and chart
                if (month <= 48) {
                    const row = document.createElement('tr');
                    if (month === timeToTarget) {
                        row.className = 'highlight';
                    }
                    row.innerHTML = `
                        <td>${month}</td>
                        <td>$${portfolioValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${monthlyIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${currentIULValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${currentBitcoinValueUSD.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${totalWealth.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    `;
                    tbody.appendChild(row);

                    // Only push chart data for months 0-48
                    chartData.labels.push(`Month ${month}`);
                    chartData.portfolio.push(portfolioValue);
                    chartData.iul.push(currentIULValue);
                    chartData.bitcoin.push(currentBitcoinValueUSD);
                    chartData.total.push(totalWealth);
                }

                // Stop charting data after 5 years unless target hasn't been
                if (month > 60 && targetReached) {
                    break;
                }
            }

            // After the monthly table, render a 5-year annual projection table
            const annualTableWrapper = document.createElement('div');
            annualTableWrapper.className = 'table-scroll';
            const annualTable = document.createElement('table');
            annualTable.className = 'projection-table';
            annualTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Portfolio Value</th>
                        <th>Annual Income</th>
                        <th>IUL Value</th>
                        <th>Bitcoin Value</th>
                        <th>Total Wealth</th>
                    </tr>
                </thead>
                <tbody id="annualProjectionBody"></tbody>
            `;
            annualTableWrapper.appendChild(annualTable);
            document.getElementById('projectionChartContainer').appendChild(annualTableWrapper);
            const annualTbody = document.getElementById('annualProjectionBody');
            for (let year = 1; year <= 5; year++) {
                // Calculate values at the end of each year
                const monthIdx = year * 12;
                if (chartData.portfolio[monthIdx] !== undefined) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${year}</td>
                        <td>$${chartData.portfolio[monthIdx].toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${(chartData.portfolio[monthIdx] * blendedYield / 100).toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${chartData.iul[monthIdx].toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${chartData.bitcoin[monthIdx].toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${chartData.total[monthIdx].toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    `;
                    annualTbody.appendChild(row);
                }
            }

            return { timeToTarget, chartData };
        }

        function renderChart(chartData) {
            if (wealthChart) {
                wealthChart.destroy();
            }

            const ctx = document.getElementById('wealthChart').getContext('2d');
            wealthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Portfolio Value',
                            data: chartData.portfolio,
                            borderColor: '#38BDF8',
                            backgroundColor: 'rgba(56,189,248,0.08)',
                            pointBackgroundColor: '#111',
                            pointBorderColor: '#38BDF8',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: false,
                            tension: 0.45
                        },
                        {
                            label: 'IUL Cash Value',
                            data: chartData.iul,
                            borderColor: '#A3E635',
                            backgroundColor: 'rgba(163,230,53,0.08)',
                            pointBackgroundColor: '#111',
                            pointBorderColor: '#A3E635',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: false,
                            tension: 0.45
                        },
                        {
                            label: 'Bitcoin Value (USD)',
                            data: chartData.bitcoin,
                            borderColor: '#F472B6',
                            backgroundColor: 'rgba(244,114,182,0.08)',
                            pointBackgroundColor: '#111',
                            pointBorderColor: '#F472B6',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: false,
                            tension: 0.45
                        },
                        {
                            label: 'Total Wealth',
                            data: chartData.total,
                            borderColor: '#FBBF24',
                            backgroundColor: 'rgba(251,191,36,0.08)',
                            pointBackgroundColor: '#111',
                            pointBorderColor: '#FBBF24',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: false,
                            tension: 0.45
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { left: 16, right: 16, top: 16, bottom: 16 }
                    },
                    scales: {
                        x: {
                            title: { display: false },
                            ticks: {
                                color: '#fff',
                                font: { size: 13, family: 'Inter, Arial' }
                            },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: false },
                            ticks: {
                                color: '#fff',
                                font: { size: 13, family: 'Inter, Arial' },
                                callback: function (value) {
                                    return '$' + Number(value).toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: { size: 14, family: 'Inter, Arial' },
                                usePointStyle: true, // Show legend colors as circles
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#181A20',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#23262F',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            titleFont: { size: 18, family: 'Inter, Arial' }, // Increased font size
                            bodyFont: { size: 18, family: 'Inter, Arial' },  // Increased font size
                            callbacks: {
                                label: function (context) {
                                    // Show whole number, no decimals
                                    return `${context.dataset.label}: $${Math.round(context.parsed.y).toLocaleString()}`;
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            borderWidth: 2,
                            hoverBorderWidth: 3
                        },
                        line: {
                            borderWidth: 3
                        }
                    }
                }
            });
        }

        // Show/hide unit inside input field
        function updateInputUnits() {
            document.querySelectorAll('.with-unit').forEach(input => {
                const wrapper = input.parentElement;
                const unitSpan = wrapper.querySelector('.input-unit');
                if (unitSpan) {
                    unitSpan.textContent = input.getAttribute('data-unit') || unitSpan.textContent;
                    unitSpan.style.display = 'block';
                }
            });
        }

        function stepInput(id, step) {
            const input = document.getElementById(id);
            if (!input) return;
            let value = parseFloat(input.value) || 0;
            value += step;
            if (input.min !== undefined && value < parseFloat(input.min)) value = parseFloat(input.min);
            if (input.max !== undefined && value > parseFloat(input.max)) value = parseFloat(input.max);
            input.value = value;
            input.dispatchEvent(new Event('input'));
            input.dispatchEvent(new Event('change'));
        }

        // Format input value with commas for thousands
        function formatNumberInput(input) {
            let val = input.value.replace(/,/g, '');
            if (val === '') return; // Don't overwrite with 0
            if (!isNaN(val)) {
                input.value = Number(val).toLocaleString('en-US');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            restoreState();
            const inputIds = [
                'totalInvestment', 'targetAmount', 'distributionFreq', 'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL', 'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin'
            ];
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', saveState);
                    el.addEventListener('change', saveState);
                }
            });
            // Update table when distribution frequency changes
            document.getElementById('distributionFreq').addEventListener('change', updatePortfolioDisplay);

            document.querySelectorAll('.with-unit').forEach(input => {
                input.addEventListener('input', function () {
                    // Only update units, do not format
                    updateInputUnits();
                });
                input.addEventListener('blur', function () {
                    formatNumberInput(input);
                    updateInputUnits();
                });
            });
            updateInputUnits();

            // Collapse/Expand Integration Grid using toggle switch
            const toggleSwitch = document.getElementById('toggleIntegrationGridSwitch');
            const integrationGridContainer = document.getElementById('integrationGridContainer');
            const toggleText = document.getElementById('toggleIntegrationGridText');
            toggleSwitch.addEventListener('change', function () {
                if (toggleSwitch.checked) {
                    integrationGridContainer.style.display = 'block';
                    toggleText.textContent = 'Hide Integrations';
                } else {
                    integrationGridContainer.style.display = 'none';
                    toggleText.textContent = 'Show Integrations';
                }
            });

            // Automatically run calculation if there is saved state and positions
            const state = JSON.parse(localStorage.getItem('dripStrategyState') || '{}');
            if (
                Array.isArray(state.positions) &&
                state.positions.length > 0 &&
                state.totalInvestment &&
                state.targetAmount &&
                !isNaN(parseFloat(state.totalInvestment)) &&
                !isNaN(parseFloat(state.targetAmount)) &&
                parseFloat(state.totalInvestment) > 0 &&
                parseFloat(state.targetAmount) > 0
            ) {
                calculateResults();
            }
        });

        function scrollToProjection() {
            const chart = document.getElementById('projectionChartContainer');
            if (chart) {
                chart.scrollIntoView({ behavior: 'smooth' });
            }
        }
    </script>
</body>

</html>