<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIP Strategy Calculator & Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;1,400;1,500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="global.css">
</head>

<body>
    <div class="container">
        <!-- Sticky Navigation Bar AT TOP -->
        <nav class="sticky-nav bespoke-nav">
            <div class="nav-content"
                style="max-width:1280px; margin:0 auto; width:100%; display:flex; align-items:center; justify-content:space-between;">
                <div class="nav-left">
                    <img src="images/bespoke-white.svg" alt="Bespoke Financial Logo" class="bespoke-logo">
                </div>
                <div class="nav-right">
                    <a class="nav-link" href="Past_Drip_Calculations.html">Past Drip Calculations</a>
                    <p class="nav-link" onclick="saveCurrentView()" style="cursor:pointer;">Save View</p>
                    <button class="btn-gold nav-calc-btn" id="calculateStrategyNavBtn"
                        onclick="calculateAndScroll()">Calculate
                        strategy</button>
                </div>
            </div>
        </nav>
        <div style="text-align:center; margin:32px;">
            <h3>DRIP Calculator</h3>
            <h1>Strategy Tracker</h1>
        </div>

        <div class="results full-width" id="results" style="display: flex;">
            <div class="result-card">
                <h3>Blended Yield</h3>
                <div class="value" id="blendedYield">0%</div>
            </div>
            <div class="result-card">
                <h3 id="incomeLabel">Weekly Income</h3>
                <div class="value" id="incomeValue">$0</div>
            </div>
            <div class="result-card">
                <h3>Annual Income</h3>
                <div class="value" id="annualIncome">$0</div>
            </div>
            <div class="result-card">
                <h3>Time to Target</h3>
                <div class="value" id="timeToTarget">0 months</div>
            </div>
        </div>

        <section class="full-width" style="margin-bottom: 16px;">
            <div class="portfolio-setup">
                <h2 style="display:inline-flex; align-items:center;gap:4px;"><svg xmlns="http://www.w3.org/2000/svg"
                        fill="none" viewBox="0 0 24 24" strokeWidth="1.5" stroke="#DDBD85" width="24" height="24">
                        <path strokeLinecap="round" strokeLinejoin="round"
                            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
                    </svg> Portfolio Setup</h2>
                <div class="input-group">
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="totalInvestment" style="display: flex; align-items: center;">
                            Starting Invesment
                            <span class="tooltip-icon" tabindex="0" style="margin-left: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#FFFFFF" />
                                    <text x="12" y="16" text-anchor="middle" font-size="16" fill="#000"
                                        font-family="Inter, Arial" font-weight="bold">?</text>
                                </svg>
                                <span class="tooltip-text">
                                    Amount you plan to add to your ETFs
                                </span>
                            </span>
                        </label>
                        <div class="input-row">
                            <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                            <input type="text" id="totalInvestment" min="0" placeholder="0"
                                class="with-unit input-no-border" data-unit="$">
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="targetAmount" style="display: flex; align-items: center;">
                            Target Amount
                            <span class="tooltip-icon" tabindex="0" style="margin-left: 8px;">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" fill="#FFFFFF" />
                                    <text x="12" y="16" text-anchor="middle" font-size="16" fill="#000"
                                        font-family="Inter, Arial" font-weight="bold">?</text>
                                </svg>
                                <span class="tooltip-text">
                                    This is your goal amount you wish to make from this strategy
                                </span>
                            </span>
                        </label>
                        <div class="input-row">
                            <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                            <input type="text" id="targetAmount" min="0" placeholder="0"
                                class="with-unit input-no-border">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="full-width" style="margin-bottom: 16px;">
            <div class="portfolio-positions">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <h2 style="display:inline-flex; align-items:center;gap:4px;"><svg xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24" strokeWidth='1.5' stroke="#DDBD85" width="24" height="24">
                            <path strokeLinecap="round" strokeLinejoin="round"
                                d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" />
                        </svg>
                        Portfolio Positions</h2>
                    <button class="add-position-text-btn" onclick="openAddPositionModal()" type="button">+ Add New
                        Position
                    </button>
                </div>
                <div id="allocationError" class="error-message" style="display: none;"></div>
                <table class="portfolio-table" id="portfolioTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Allocation %</th>
                            <th>Amount</th>
                            <th>Yield %</th>
                            <th>Annual Income</th>
                            <th>Weekly Income</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Integration Grid Toggle Switch -->
        <div class="card"
            style="width:100%; display:flex;align-items: center; justify-content:space-between; margin-bottom:16px;">
            <h2 style="display:inline-flex; align-items:center;gap:4px;"><svg xmlns="http://www.w3.org/2000/svg"
                    fill="none" color="#DDBD85" viewBox="0 0 24 24" strokeWidth="1.5" stroke="#DDBD85" width="24"
                    height="24">
                    <path strokeLinecap="round" strokeLinejoin="round"
                        d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                Additional Income</h2>
            <div style="display: flex; align-items: center;">
                <label class="toggle-switch" id="integrationToggleLabel">
                    <input type="checkbox" id="toggleIntegrationGridSwitch" checked>
                    <span class="slider"></span>
                </label>
                <span id="toggleIntegrationGridText"
                    style="margin-left:12px; color:#fff; font-weight:400; font-size:.95rem;margin-bottom:8px;">Hide
                    Integrations</span>
            </div>
        </div>

        <div id="integrationGridContainer" style="width: 100%;">
            <div class="integration-grid" style="display: flex; gap: 32px; width: 100;">
                <div class="card iul-integration">
                    <h2 style="display:inline-flex; align-items:center;gap:4px;"><svg xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24" strokeWidth="1.5" color="#DDBD85" stroke="currentColor"
                            width="24" height="24">
                            <path strokeLinecap="round" strokeLinejoin="round"
                                d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        IUL Integration</h2>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulPremium">Monthly IUL Premium</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="iulPremium" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulCashValue">Current Cash Value</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="iulCashValue" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulGrowthRate">Expected Growth Rate</label>
                            <div class="input-row">
                                <input type="number" id="iulGrowthRate" min="0" placeholder="0" class="with-unit">
                                <span class="input-unit input-unit-right">%</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="reinvestToIUL">Reinvest % to IUL</label>
                            <div class="input-row">
                                <input type="number" id="reinvestToIUL" min="0" max="100" placeholder="0"
                                    class="with-unit">
                                <span class="input-unit input-unit-right">%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bitcoin-integration">
                    <h2><span style="color:#DDBD85;margin-right:4px;">â‚¿</span>Bitcoin Integration</h2>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinAmountBTC">Current Bitcoin Amount (BTC)</label>
                            <div class="input-row">
                                <input type="number" id="bitcoinAmountBTC" min="0" placeholder="0"
                                    class="with-unit input-no-border" data-unit="BTC">
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinPriceUSD">Current Bitcoin Price</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="bitcoinPriceUSD" min="0" placeholder="0"
                                    class="with-unit input-no-border" data-unit="$">
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinCAGR">Bitcoin CAGR (%)</label>
                            <div class="input-row">
                                <input type="number" id="bitcoinCAGR" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <span class="input-unit input-unit-right">%</span>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinMonthlySavingsUSD">Monthly Bitcoin Savings</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="bitcoinMonthlySavingsUSD" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="reinvestToBitcoin">Reinvest % to Bitcoin</label>
                            <div class="input-row">
                                <input type="number" id="reinvestToBitcoin" min="0" max="100" placeholder="0"
                                    class="with-unit input-no-border">
                                <span class="input-unit input-unit-right">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="projection-chart card full-width" style="height:600px;" id="projectionChartContainer">
            <h2 style="display:inline-flex; align-items:center;gap:4px;"><svg xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24" strokeWidth='1.5' stroke="#DDBD85" width="24" height="24">
                    <path strokeLinecap="round" strokeLinejoin="round"
                        d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5m.75-9 3-3 2.148 2.148A12.061 12.061 0 0 1 16.5 7.605" />
                </svg> Monthly Growth Projection</h2>
            <canvas id="wealthChart" style="margin-bottom: 16px; height: 400px; width: 100%;"></canvas>
            <div class="table-scroll">
                <table class="projection-table" id="projectionTable" style="width: 100%; max-width: 1280px;">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Portfolio Value</th>
                            <th>Monthly Income</th>
                            <th>IUL Value</th>
                            <th>Bitcoin Value</th>
                            <th>Total Wealth</th>
                        </tr>
                    </thead>
                    <tbody id="projectionBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add floating calculate button -->
    <div class="floating-btn-container">
        <!-- Floating button group removed, navigation now handles Calculate -->
    </div>

    <div class="modal" id="addPositionModal">
        <div class="modal-content">
            <h3>Add New Position</h3>
            <div class="input-group">
                <div style="display: flex; flex-direction: column;">
                    <label for="modalTicker">Ticker Symbol</label>
                    <input type="text" id="modalTicker" placeholder="e.g., AAPL" class="input-row">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="modalAllocation">Allocation (%)</label>
                    <input type="number" id="modalAllocation" step="0.1" min="0" placeholder="e.g., 25"
                        class="input-row">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="modalYield">Yield (%)</label>
                    <input type="number" id="modalYield" step="0.1" min="0" placeholder="e.g., 5" class="input-row">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="modalFrequency">Distribution Frequency</label>
                    <select id="modalFrequency" class="input-row">
                        <option value="52">Weekly (52x/year)</option>
                        <option value="13" selected>Monthly (13x/year)</option>
                    </select>
                </div>
            </div>
            <div id="modalError" class="error-message" style="display: none;"></div>
            <button class="btn" id="modalSubmitBtn" onclick="submitNewPosition()">Add Position</button>
            <button class="close-btn" onclick="closeAddPositionModal()">Cancel</button>
        </div>
    </div>

    <div class="modal" id="saveViewModal">
        <div class="modal-content">
            <h3>Name This Saved View</h3>
            <div class="input-group">
                <input type="text" id="saveViewNameInput" class="input-row" placeholder="e.g., My DRIP Plan">
            </div>
            <div id="saveViewError" class="error-message" style="display:none;"></div>
            <button class="btn" id="saveViewSubmitBtn">Save</button>
            <button class="close-btn" onclick="closeSaveViewModal()">Cancel</button>
        </div>
    </div>

    <script>
        // Calculate and scroll to chart
        function calculateAndScroll() {
            try {
                calculateResults();
            } catch (e) {
                console.error('Calculation error:', e);
            }
            const container = document.getElementById('projectionChartContainer');
            if (container) {
                container.style.display = 'block';
                // Ensure scroll after layout/paint
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    });
                });
            }
        }
        let positions = [];
        let positionCounter = 0;
        let wealthChart = null;
        let editingPositionId = null; // Track which position is being edited

        // Save all inputs and positions to localStorage
        function saveState() {
            const inputs = [
                'totalInvestment', 'targetAmount',
                'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL',
                'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin'
            ];
            const state = {};
            inputs.forEach(id => {
                const el = document.getElementById(id);
                // Save raw value without commas
                state[id] = el ? el.value.replace(/,/g, '') : '';
            });
            state.positions = positions;
            localStorage.setItem('dripStrategyState', JSON.stringify(state));
        }

        // Save View logic
        function openSaveViewModal() {
            document.getElementById('saveViewModal').style.display = 'flex';
            document.getElementById('saveViewNameInput').value = '';
            document.getElementById('saveViewError').style.display = 'none';
        }
        function closeSaveViewModal() {
            document.getElementById('saveViewModal').style.display = 'none';
        }
        window.saveCurrentView = function () {
            openSaveViewModal();
        }
        document.getElementById('saveViewSubmitBtn').onclick = function () {
            const name = document.getElementById('saveViewNameInput').value.trim();
            const successMsg = document.getElementById('saveViewError');
            if (!name) {
                successMsg.textContent = 'Please enter a name.';
                successMsg.style.display = 'block';
                successMsg.style.color = '#FF4747';
                return;
            }
            const state = JSON.parse(localStorage.getItem('dripStrategyState') || '{}');
            const saved = JSON.parse(localStorage.getItem('dripSavedViews') || '[]');
            saved.push({
                name,
                date: new Date().toLocaleString(),
                data: state
            });
            localStorage.setItem('dripSavedViews', JSON.stringify(saved));
            successMsg.textContent = 'Successfully saved!';
            successMsg.style.display = 'block';
            successMsg.style.color = '#DDBD85'; // Tailwind green-500
            setTimeout(function () {
                closeSaveViewModal();
                window.location.href = 'Past_Drip_Calculations.html';
            }, 1200);
        }

        // Restore all inputs and positions from localStorage
        function restoreState() {
            const state = JSON.parse(localStorage.getItem('dripStrategyState') || '{}');
            const inputs = [
                'totalInvestment', 'targetAmount',
                'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL',
                'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin'
            ];
            const currencyIds = ['totalInvestment', 'targetAmount', 'iulPremium', 'iulCashValue', 'bitcoinPriceUSD', 'bitcoinMonthlySavingsUSD'];

            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el && state[id] !== undefined) {
                    if (currencyIds.includes(id)) {
                        // Ensure commas are shown for currency fields
                        el.value = state[id] === '' ? '' : Number(state[id]).toLocaleString('en-US');
                    } else {
                        el.value = state[id];
                    }
                }
            });
            if (Array.isArray(state.positions)) {
                positions = state.positions;
                positionCounter = positions.length > 0 ? Math.max(...positions.map(p => p.id)) + 1 : 0;
            }
            updatePortfolioDisplay();
        }

        // Initialize with no default positions
        function initializeDefaultPositions() {
            positions = [];
            positionCounter = 0;
            updatePortfolioDisplay();
        }

        function openAddPositionModal(editId = null) {
            document.getElementById('addPositionModal').style.display = 'flex';
            document.getElementById('modalError').style.display = 'none';
            editingPositionId = editId;

            const submitBtn = document.getElementById('modalSubmitBtn');
            if (editId !== null) {
                // Editing existing position
                const pos = positions.find(p => p.id === editId);
                if (pos) {
                    document.getElementById('modalTicker').value = pos.ticker;
                    document.getElementById('modalAllocation').value = pos.allocation;
                    document.getElementById('modalYield').value = pos.yield;
                    // Set frequency dropdown to saved value, default to 13 if missing
                    document.getElementById('modalFrequency').value = (pos.frequency === 52 || pos.frequency === 13) ? pos.frequency : 13;
                }
                submitBtn.textContent = 'Update Position';
            } else {
                // Adding new position
                document.getElementById('modalTicker').value = '';
                document.getElementById('modalAllocation').value = '';
                document.getElementById('modalYield').value = '';
                document.getElementById('modalFrequency').value = 13;
                submitBtn.textContent = 'Add Position';
            }
        }

        function closeAddPositionModal() {
            document.getElementById('addPositionModal').style.display = 'none';
        }

        function submitNewPosition() {
            const ticker = document.getElementById('modalTicker').value.trim().toUpperCase();
            const allocation = parseFloat(document.getElementById('modalAllocation').value);
            const yieldRate = parseFloat(document.getElementById('modalYield').value);

            if (!ticker || isNaN(allocation) || isNaN(yieldRate) || allocation <= 0 || yieldRate < 0) {
                document.getElementById('modalError').textContent = 'Please enter valid values for all fields.';
                document.getElementById('modalError').style.display = 'block';
                return;
            }

            let totalAllocation;
            const frequency = parseInt(document.getElementById('modalFrequency').value);
            if (editingPositionId !== null) {
                // Editing existing position
                const pos = positions.find(p => p.id === editingPositionId);
                if (pos) {
                    // Calculate allocation excluding the current position
                    totalAllocation = positions.reduce((sum, p) => sum + (p.id === editingPositionId ? 0 : p.allocation), 0) + allocation;
                    if (totalAllocation > 100) {
                        document.getElementById('modalError').textContent = 'Total allocation exceeds 100%.';
                        document.getElementById('modalError').style.display = 'block';
                        return;
                    }
                    pos.ticker = ticker;
                    pos.allocation = allocation;
                    pos.yield = yieldRate;
                    pos.frequency = frequency;
                }
                editingPositionId = null;
            } else {
                // Adding new position
                totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0) + allocation;
                if (totalAllocation > 100) {
                    document.getElementById('modalError').textContent = 'Total allocation exceeds 100%.';
                    document.getElementById('modalError').style.display = 'block';
                    return;
                }
                positions.push({
                    id: positionCounter++,
                    ticker: ticker,
                    allocation: allocation,
                    yield: yieldRate,
                    frequency: frequency
                });
            }
            saveState();
            updatePortfolioDisplay();
            closeAddPositionModal();
        }

        function removePosition(id) {
            positions = positions.filter(pos => pos.id !== id);
            saveState();
            updatePortfolioDisplay();
        }

        function updatePortfolioDisplay() {
            const tbody = document.getElementById('portfolioBody');
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);

            // Update table header to always show 'Monthly Income'
            const ths = document.querySelectorAll('#portfolioTable thead th');
            if (ths.length >= 6) {
                ths[5].textContent = 'Monthly Income';
            }

            const allocationError = document.getElementById('allocationError');
            if (totalAllocation > 100) {
                allocationError.textContent = `Total allocation (${totalAllocation.toFixed(1)}%) exceeds 100%. Please adjust.`;
                allocationError.style.display = 'block';
            } else {
                allocationError.style.display = 'none';
            }

            tbody.innerHTML = '';

            positions.forEach(position => {
                const amount = (totalInvestment * position.allocation / 100);
                const annualIncome = (amount * position.yield / 100);
                // Calculate monthly income based on position frequency
                let monthlyIncome;
                if (position.frequency === 52) {
                    // Weekly: annualIncome / 52 weeks, then times 4 (approximate weeks per month)
                    monthlyIncome = annualIncome / 52 * 4;
                } else if (position.frequency === 13) {
                    // Monthly: annualIncome / 13 (monthly distributions per year)
                    monthlyIncome = annualIncome / 13;
                } else {
                    // Default to monthly if frequency is missing or invalid
                    monthlyIncome = annualIncome / 13;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${position.ticker}</td>
            <td>${position.allocation}%</td>
            <td>$${amount.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
            <td>${position.yield}%</td>
            <td>$${annualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
            <td>$${monthlyIncome.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
            <td>
                <button class="edit-btn" onclick="openAddPositionModal(${position.id})">Edit</button>
                <button class="remove-btn" onclick="removePosition(${position.id})">Remove</button>
            </td>
        `;
                tbody.appendChild(row);
            });

            // Add summary row if there are positions
            if (positions.length > 0) {
                const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
                const totalAmount = positions.reduce((sum, pos) => sum + (totalInvestment * pos.allocation / 100), 0);
                const totalAnnualIncome = positions.reduce((sum, pos) => sum + ((totalInvestment * pos.allocation / 100) * pos.yield / 100), 0);
                const totalMonthlyIncome = positions.reduce((sum, pos) => {
                    const amount = totalInvestment * pos.allocation / 100;
                    const annualIncome = amount * pos.yield / 100;
                    let monthlyIncome;
                    if (pos.frequency === 52) {
                        monthlyIncome = annualIncome / 52 * 4;
                    } else if (pos.frequency === 13) {
                        monthlyIncome = annualIncome / 13;
                    } else {
                        monthlyIncome = annualIncome / 13;
                    }
                    return sum + monthlyIncome;
                }, 0);
                // Calculate blended yield
                let totalWeightedYield = 0;
                positions.forEach(position => {
                    totalWeightedYield += position.allocation * position.yield;
                });
                const blendedYield = totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;
                const summaryRow = document.createElement('tr');
                summaryRow.className = 'summary-row';
                summaryRow.innerHTML = `
            <td style="font-weight:bold;">Total</td>
            <td style="font-weight:bold;">${totalAllocation.toFixed(0)}%</td>
            <td style="font-weight:bold;">$${totalAmount.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
            <td style="font-weight:bold;">${blendedYield.toFixed(0)}%</td>
            <td style="font-weight:bold;">$${totalAnnualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
            <td style="font-weight:bold;">$${totalMonthlyIncome.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
            <td></td>
        `;
                tbody.appendChild(summaryRow);
            }
        }

        function calculateResults() {
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value.replace(/,/g, '')) || 0;
            const reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
            const reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;

            if (totalInvestment <= 0 || targetAmount <= 0) {
                alert('Total Investment and Target Amount must be greater than 0.');
                return;
            }
            if (positions.length === 0) {
                alert('Please add at least one position.');
                return;
            }
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            if (totalAllocation > 100) {
                alert('Total allocation exceeds 100%. Please adjust.');
                return;
            }
            if (reinvestToIUL + reinvestToBitcoin > 100) {
                alert('The sum of reinvestment percentages for IUL and Bitcoin cannot exceed 100%.');
                return;
            }

            let totalWeightedYield = 0;
            positions.forEach(position => {
                totalWeightedYield += position.allocation * position.yield;
            });

            const blendedYield = totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;
            const annualIncome = totalInvestment * blendedYield / 100;
            const weeklyIncome = annualIncome / 52;

            const projectionResults = generateAndRenderProjections();

            // Calculate blended monthly income from all positions
            let blendedMonthlyIncome = 0;
            positions.forEach(position => {
                const amount = totalInvestment * position.allocation / 100;
                const annualIncome = amount * position.yield / 100;
                let monthlyIncome;
                if (position.frequency === 52) {
                    monthlyIncome = annualIncome / 52 * 4;
                } else if (position.frequency === 13) {
                    monthlyIncome = annualIncome / 13;
                } else {
                    monthlyIncome = annualIncome / 13;
                }
                blendedMonthlyIncome += monthlyIncome;
            });

            document.getElementById('incomeLabel').textContent = 'Monthly Income';
            document.getElementById('blendedYield').textContent = blendedYield.toFixed(0) + '%';
            document.getElementById('incomeValue').textContent = '$' + blendedMonthlyIncome.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('annualIncome').textContent = '$' + annualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 });
            document.getElementById('timeToTarget').textContent = projectionResults.timeToTarget !== 'N/A' ? `${projectionResults.timeToTarget} months` : 'N/A';

            // FIX: Do not change display style here!
            // Remove or comment out this line:
            // document.getElementById('results').style.display = 'grid';

            document.getElementById('projectionChartContainer').style.display = 'block';

            renderChart(projectionResults.chartData);
        }

        function generateAndRenderProjections() {
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value.replace(/,/g, '')) || 0;
            const iulPremium = parseFloat(document.getElementById('iulPremium').value.replace(/,/g, '')) || 0;
            const iulCashValue = parseFloat(document.getElementById('iulCashValue').value.replace(/,/g, '')) || 0;
            const iulGrowthRate = parseFloat(document.getElementById('iulGrowthRate').value) || 0;
            const reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
            const bitcoinAmountBTC = parseFloat(document.getElementById('bitcoinAmountBTC').value) || 0;
            const initialBitcoinPriceUSD = parseFloat(document.getElementById('bitcoinPriceUSD').value.replace(/,/g, '')) || 60000;
            const bitcoinCAGR = parseFloat(document.getElementById('bitcoinCAGR').value) || 0;
            const bitcoinMonthlySavingsUSD = parseFloat(document.getElementById('bitcoinMonthlySavingsUSD').value.replace(/,/g, '')) || 0;
            const reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;

            // Check if IUL and Bitcoin sections should be displayed
            const showIUL = (iulPremium > 0 || iulCashValue > 0 || reinvestToIUL > 0);
            const showBitcoin = (bitcoinAmountBTC > 0 || bitcoinMonthlySavingsUSD > 0 || reinvestToBitcoin > 0);

            let totalWeightedYield = 0;
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            positions.forEach(position => {
                totalWeightedYield += position.allocation * position.yield;
            });
            const blendedYield = totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;

            // Calculate blended monthly income based on all positions
            let blendedMonthlyIncome = 0;
            positions.forEach(position => {
                const amount = totalInvestment * position.allocation / 100;
                const annualIncome = amount * position.yield / 100;
                let monthlyIncome;
                if (position.frequency === 52) {
                    monthlyIncome = annualIncome / 52 * 4;
                } else if (position.frequency === 13) {
                    monthlyIncome = annualIncome / 13;
                } else {
                    monthlyIncome = annualIncome / 13;
                }
                blendedMonthlyIncome += monthlyIncome;
            });
            const monthlyYield = blendedMonthlyIncome / totalInvestment;
            const monthlyIULGrowth = iulGrowthRate / 100 / 12;
            const monthlyBitcoinGrowth = Math.pow(1 + bitcoinCAGR / 100, 1 / 12) - 1;

            let portfolioValue = totalInvestment;
            let currentIULValue = iulCashValue;
            let currentBitcoinAmountBTC = bitcoinAmountBTC;
            let currentBitcoinPriceUSD = initialBitcoinPriceUSD;

            const tbody = document.getElementById('projectionBody');
            tbody.innerHTML = '';

            // Update table headers to hide/show IUL and Bitcoin columns
            const monthlyTable = document.getElementById('projectionTable');
            const monthlyHeaders = monthlyTable.querySelectorAll('thead th');
            if (monthlyHeaders.length >= 6) {
                monthlyHeaders[3].style.display = showIUL ? '' : 'none'; // IUL Value column
                monthlyHeaders[4].style.display = showBitcoin ? '' : 'none'; // Bitcoin Value column
            }

            const chartData = { labels: [], portfolio: [], iul: [], bitcoin: [], total: [] };
            let timeToTarget = 'N/A';


            // --- Collect annual chart data ---
            const annualChartData = { labels: [], portfolio: [], iul: [], bitcoin: [], total: [] };
            // Use only one declaration for timeToTarget and targetReached
            let annualPortfolioValue = totalInvestment;
            let annualIULValue = iulCashValue;
            let annualBitcoinAmountBTC = bitcoinAmountBTC;
            let annualBitcoinPriceUSD = initialBitcoinPriceUSD;

            for (let year = 0; year <= 10; year++) {
                // Simulate compounding for 12 months each year
                for (let m = 1; m <= 12; m++) {
                    const monthlyIncome = annualPortfolioValue * monthlyYield;
                    const toIUL = monthlyIncome * (reinvestToIUL / 100);
                    const toBitcoin = monthlyIncome * (reinvestToBitcoin / 100);
                    const toDRIP = monthlyIncome - toIUL - toBitcoin;

                    annualPortfolioValue += toDRIP;
                    annualIULValue += toIUL + iulPremium;
                    annualIULValue *= (1 + monthlyIULGrowth);

                    const btcFromSavings = bitcoinMonthlySavingsUSD / annualBitcoinPriceUSD;
                    const btcFromReinvest = toBitcoin / annualBitcoinPriceUSD;
                    annualBitcoinAmountBTC += btcFromSavings + btcFromReinvest;

                    annualBitcoinPriceUSD *= (1 + monthlyBitcoinGrowth);
                }
                const annualBitcoinValueUSD = annualBitcoinAmountBTC * annualBitcoinPriceUSD;
                const annualTotalWealth = annualPortfolioValue + annualIULValue + annualBitcoinValueUSD;

                if (annualTotalWealth >= targetAmount && timeToTarget === 'N/A') {
                    timeToTarget = year;
                    targetReached = true;
                }

                annualChartData.labels.push(`Year ${year}`);
                annualChartData.portfolio.push(annualPortfolioValue);
                annualChartData.iul.push(annualIULValue);
                annualChartData.bitcoin.push(annualBitcoinValueUSD);
                annualChartData.total.push(annualTotalWealth);
            }

            // --- Keep monthly table logic for display, but chart will use annualChartData ---
            portfolioValue = totalInvestment;
            currentIULValue = iulCashValue;
            currentBitcoinAmountBTC = bitcoinAmountBTC;
            currentBitcoinPriceUSD = initialBitcoinPriceUSD;
            let targetMonth = null;
            portfolioValue = totalInvestment;
            currentIULValue = iulCashValue;
            currentBitcoinAmountBTC = bitcoinAmountBTC;
            currentBitcoinPriceUSD = initialBitcoinPriceUSD;
            for (let month = 0; month <= 48; month++) {
                const monthlyIncome = portfolioValue * monthlyYield;
                const toIUL = monthlyIncome * (reinvestToIUL / 100);
                const toBitcoin = monthlyIncome * (reinvestToBitcoin / 100);
                const toDRIP = monthlyIncome - toIUL - toBitcoin;

                if (month > 0) {
                    portfolioValue += toDRIP;
                    currentIULValue += toIUL + iulPremium;
                    currentIULValue *= (1 + monthlyIULGrowth);
                    const btcFromSavings = bitcoinMonthlySavingsUSD / currentBitcoinPriceUSD;
                    const btcFromReinvest = toBitcoin / currentBitcoinPriceUSD;
                    currentBitcoinAmountBTC += btcFromSavings + btcFromReinvest;
                    currentBitcoinPriceUSD *= (1 + monthlyBitcoinGrowth);
                }

                const currentBitcoinValueUSD = currentBitcoinAmountBTC * currentBitcoinPriceUSD;
                const totalWealth = portfolioValue + currentIULValue + currentBitcoinValueUSD;

                // Find the first month where target is reached
                if (targetMonth === null && totalWealth >= targetAmount) {
                    targetMonth = month;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>$${portfolioValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${monthlyIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td style="display:${showIUL ? '' : 'none'}">$${currentIULValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td style="display:${showBitcoin ? '' : 'none'}">$${currentBitcoinValueUSD.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${totalWealth.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                `;
                if (targetMonth !== null && month === targetMonth) {
                    row.style.background = '#DDBD85';
                    row.style.color = '#fff';
                }
                tbody.appendChild(row);
            }
            // Set timeToTarget to targetMonth for consistency
            timeToTarget = targetMonth !== null ? targetMonth : 'N/A';

            Array.from(projectionChartContainer.querySelectorAll('.table-scroll')).forEach((el, idx) => {
                if (idx > 0) el.remove();
            });

            // --- Annual table: create and insert after chart but before monthly table ---
            const annualTableWrapper = document.createElement('div');
            annualTableWrapper.className = 'table-scroll';
            const annualTable = document.createElement('table');
            annualTable.className = 'projection-table';
            annualTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Portfolio Value</th>
                        <th>Annual Income</th>
                        ${showIUL ? '<th>IUL Value</th>' : ''}
                        ${showBitcoin ? '<th>Bitcoin Value</th>' : ''}
                        <th>Total Wealth</th>
                    </tr>
                </thead>
                <tbody id="annualProjectionBody"></tbody>
            `;
            annualTableWrapper.appendChild(annualTable);
            const chartCanvas = document.getElementById('wealthChart');
            // Insert annual table after chartCanvas
            if (chartCanvas && chartCanvas.parentNode) {
                chartCanvas.parentNode.insertBefore(annualTableWrapper, chartCanvas.nextSibling);
            }
            const annualTbody = annualTable.querySelector('tbody');

            // Calculate annual values for years 1-10 using compounding logic
            for (let year = 1; year <= 10; year++) {
                let months = year * 12;
                let portfolioValue = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
                let iulValue = parseFloat(document.getElementById('iulCashValue').value.replace(/,/g, '')) || 0;
                let bitcoinAmountBTC = parseFloat(document.getElementById('bitcoinAmountBTC').value) || 0;
                let bitcoinPriceUSD = parseFloat(document.getElementById('bitcoinPriceUSD').value.replace(/,/g, '')) || 60000;

                // Use input values for rates
                let blendedYield = (() => {
                    let totalWeightedYield = 0;
                    let totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
                    positions.forEach(position => {
                        totalWeightedYield += position.allocation * position.yield;
                    });
                    return totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;
                })();
                let monthlyYield = blendedYield / 100 / 12;
                let iulPremium = parseFloat(document.getElementById('iulPremium').value.replace(/,/g, '')) || 0;
                let iulGrowthRate = parseFloat(document.getElementById('iulGrowthRate').value) || 0;
                let monthlyIULGrowth = iulGrowthRate / 100 / 12;
                let reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
                let bitcoinCAGR = parseFloat(document.getElementById('bitcoinCAGR').value) || 0;
                let monthlyBitcoinGrowth = Math.pow(1 + bitcoinCAGR / 100, 1 / 12) - 1;
                let bitcoinMonthlySavingsUSD = parseFloat(document.getElementById('bitcoinMonthlySavingsUSD').value.replace(/,/g, '')) || 0;
                let reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;

                // Simulate compounding for 'months'
                let extPortfolioValue = portfolioValue;
                let extIULValue = iulValue;
                let extBitcoinAmountBTC = bitcoinAmountBTC;
                let extBitcoinPriceUSD = bitcoinPriceUSD;

                for (let m = 1; m <= months; m++) {
                    const monthlyIncome = extPortfolioValue * monthlyYield;
                    const toIUL = monthlyIncome * (reinvestToIUL / 100);
                    const toBitcoin = monthlyIncome * (reinvestToBitcoin / 100);
                    const toDRIP = monthlyIncome - toIUL - toBitcoin;

                    extPortfolioValue += toDRIP;
                    extIULValue += toIUL + iulPremium;
                    extIULValue *= (1 + monthlyIULGrowth);

                    const btcFromSavings = bitcoinMonthlySavingsUSD / extBitcoinPriceUSD;
                    const btcFromReinvest = toBitcoin / extBitcoinPriceUSD;
                    extBitcoinAmountBTC += btcFromSavings + btcFromReinvest;

                    extBitcoinPriceUSD *= (1 + monthlyBitcoinGrowth);
                }
                const extBitcoinValueUSD = extBitcoinAmountBTC * extBitcoinPriceUSD;
                const extTotalWealth = extPortfolioValue + extIULValue + extBitcoinValueUSD;
                const extAnnualIncome = extPortfolioValue * blendedYield / 100;

                let rowHTML = `
                    <td>${year}</td>
                    <td>$${extPortfolioValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${extAnnualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                `;
                if (showIUL) {
                    rowHTML += `<td>$${extIULValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>`;
                }
                if (showBitcoin) {
                    rowHTML += `<td>$${extBitcoinValueUSD.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>`;
                }
                rowHTML += `<td>$${extTotalWealth.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>`;

                const row = document.createElement('tr');
                row.innerHTML = rowHTML;
                annualTbody.appendChild(row);
            }

            // Also update the chart datasets
            if (!showIUL) {
                annualChartData.iul = [];
            }
            if (!showBitcoin) {
                annualChartData.bitcoin = [];
            }
            return { timeToTarget, chartData: annualChartData };
        }

        function renderChart(chartData) {
            if (wealthChart) {
                wealthChart.destroy();
            }

            const ctx = document.getElementById('wealthChart').getContext('2d');

            // Create datasets array with only visible data series
            const datasets = [
                {
                    label: 'Portfolio Value',
                    data: chartData.portfolio,
                    borderColor: '#8B80F9',
                    backgroundColor: 'rgba(56,189,248,0.08)',
                    pointBackgroundColor: '#8B80F9',
                    pointBorderColor: '#8B80F9',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.45
                },
                {
                    label: 'Total Wealth',
                    data: chartData.total,
                    borderColor: '#DDBD85',
                    backgroundColor: 'rgba(251,191,36,0.08)',
                    pointBackgroundColor: '#DDBD85',
                    pointBorderColor: '#DDBD85',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.45
                }
            ];

            // Only add IUL dataset if it has values
            if (chartData.iul && chartData.iul.length > 0) {
                datasets.splice(1, 0, {
                    label: 'IUL Cash Value',
                    data: chartData.iul,
                    borderColor: '#3D6BA1',
                    backgroundColor: 'rgba(163,230,53,0.08)',
                    pointBackgroundColor: '#3D6BA1',
                    pointBorderColor: '#3D6BA1',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.45
                });
            }

            // Only add Bitcoin dataset if it has values
            if (chartData.bitcoin && chartData.bitcoin.length > 0) {
                datasets.splice(datasets.length - 1, 0, {
                    label: 'Bitcoin Value (USD)',
                    data: chartData.bitcoin,
                    borderColor: '#F7931A',
                    backgroundColor: 'rgba(244,114,182,0.08)',
                    pointBackgroundColor: '#F7931A',
                    pointBorderColor: '#F7931A',
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.45
                });
            }

            wealthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { left: 16, right: 16, top: 16, bottom: 16 }
                    },
                    scales: {
                        x: {
                            title: { display: false },
                            ticks: {
                                color: '#fff',
                                font: { size: 13, family: 'Inter, Arial' }
                            },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        },
                        y: {
                            beginAtZero: true,
                            title: { display: false },
                            ticks: {
                                color: '#fff',
                                font: { size: 13, family: 'Inter, Arial' },
                                callback: function (value) {
                                    return '$' + Number(value).toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: { size: 14, family: 'Inter, Arial' },
                                usePointStyle: true, // Show legend colors as circles
                                pointStyle: 'circle',
                                pointRadius: 4, // Make circles smaller (default is 6)
                                boxWidth: 10, // Reduce box width for smaller circles
                                padding: 24 // Add space between legend items
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#181A20',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#23262F',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            titleFont: { size: 18, family: 'Inter, Arial' }, // Increased font size
                            bodyFont: { size: 18, family: 'Inter, Arial' },  // Increased font size
                            callbacks: {
                                label: function (context) {
                                    // Show whole number, no decimals
                                    return `${context.dataset.label}: $${Math.round(context.parsed.y).toLocaleString()}`;
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    }
                }
            });
        }

        // Show/hide unit inside input field
        function updateInputUnits() {
            document.querySelectorAll('.with-unit').forEach(input => {
                const wrapper = input.parentElement;
                const unitSpan = wrapper.querySelector('.input-unit');
                if (unitSpan) {
                    unitSpan.textContent = input.getAttribute('data-unit') || unitSpan.textContent;
                    unitSpan.style.display = 'block';
                }
            });
        }

        function stepInput(id, step) {
            const input = document.getElementById(id);
            if (!input) return;
            let value = parseFloat(input.value) || 0;
            value += step;
            if (input.min !== undefined && value < parseFloat(input.min)) value = parseFloat(input.min);
            if (input.max !== undefined && value > parseFloat(input.max)) value = parseFloat(input.max);
            input.value = value;
            input.dispatchEvent(new Event('input'));
            input.dispatchEvent(new Event('change'));
        }

        // Format input value with commas for thousands
        function formatNumberInput(input) {
            let val = input.value.replace(/,/g, '');
            if (val === '') return; // Don't overwrite with 0
            if (!isNaN(val)) {
                input.value = Number(val).toLocaleString('en-US');
            }
        }

        // Improved: Format input value with commas as you type, but allow any length and decimals
        function formatWithCommas(input) {
            let val = input.value.replace(/,/g, '');
            if (val === '') return;
            if (/^-?\d*\.?\d*$/.test(val)) {
                if (val.match(/\.\d*$/)) {
                    input.value = val;
                } else {
                    let parts = val.split('.');
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    input.value = parts.length > 1 ? parts[0] + '.' + parts[1] : parts[0];
                }
            }
        }

        // Attach listeners after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            restoreState();

            const currencyIds = ['totalInvestment', 'targetAmount', 'iulPremium', 'iulCashValue', 'bitcoinPriceUSD', 'bitcoinMonthlySavingsUSD'];

            // Set up live comma formatting on currency inputs only
            currencyIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                try { el.type = 'text'; } catch (e) { }
                el.addEventListener('input', () => {
                    const caretStart = el.selectionStart || 0;
                    const before = el.value;
                    formatWithCommas(el);
                    const diff = (el.value.length - before.length);
                    const newPos = Math.max(0, caretStart + diff);
                    el.setSelectionRange(newPos, newPos);
                    saveState();
                });
                el.addEventListener('change', saveState);
            });

            // For non-currency numeric inputs, just save on change/input
            ['iulGrowthRate', 'reinvestToIUL', 'bitcoinAmountBTC', 'bitcoinCAGR', 'reinvestToBitcoin'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', saveState);
                el.addEventListener('change', saveState);
            });
        });

        // Collapse/Expand Integration Grid using toggle switch
        const toggleSwitch = document.getElementById('toggleIntegrationGridSwitch');
        const integrationGridContainer = document.getElementById('integrationGridContainer');
        const toggleText = document.getElementById('toggleIntegrationGridText');
        toggleSwitch.addEventListener('change', function () {
            if (toggleSwitch.checked) {
                integrationGridContainer.style.display = 'block';
                toggleText.textContent = 'Hide Integrations';
            } else {
                integrationGridContainer.style.display = 'none';
                toggleText.textContent = 'Show Integrations';
            }
        });

        // Automatically run calculation if there is saved state and positions
        const state = JSON.parse(localStorage.getItem('dripStrategyState') || '{}');
        if (
            Array.isArray(state.positions) &&
            state.positions.length > 0 &&
            state.totalInvestment &&
            state.targetAmount &&
            !isNaN(parseFloat(state.totalInvestment)) &&
            !isNaN(parseFloat(state.targetAmount)) &&
            parseFloat(state.totalInvestment) > 0 &&
            parseFloat(state.targetAmount) > 0
        ) {
            calculateResults();
        }

        function scrollToProjection() {
            const chart = document.getElementById('projectionChartContainer');
            if (chart) {
                chart.scrollIntoView({ behavior: 'smooth' });
            }
        }
    </script>
</body>

</html>