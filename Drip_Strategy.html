<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIP Strategy Calculator & Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;1,400;1,500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="global.css">
</head>

<body>
    <div class="container">
        <div style="text-align:center; margin:32px;">
            <h3>DRIP Cycle</h3>
            <h1>Strategy Calculator</h1>
        </div>

        <div class="results full-width" id="results" style="display: flex;">
            <div class="result-card">
                <h3>Blended Yield</h3>
                <div class="value" id="blendedYield">0%</div>
            </div>
            <div class="result-card">
                <h3 id="incomeLabel">Weekly Income</h3>
                <div class="value" id="incomeValue">$0</div>
            </div>
            <div class="result-card">
                <h3>Annual Income</h3>
                <div class="value" id="annualIncome">$0</div>
            </div>
            <div class="result-card">
                <h3>Time to Target</h3>
                <div class="value" id="timeToTarget">0 months</div>
            </div>
        </div>

        <section class="full-width" style="margin-bottom: 16px;">
            <div class="purchasing-power card"
                style="padding: 24px; margin-bottom: 16px; display: flex; align-items: center; gap: 32px; background: #23262F; border-radius: 16px;">
                <h2 style="margin: 0 24px 0 0;">ðŸ’µ Purchasing Power</h2>
                <div style="display: flex; flex-direction: column; min-width: 220px;">
                    <label for="currentIncome" style="margin-bottom: 4px; font-weight: 500;">Current Income</label>
                    <div class="input-row">
                        <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                        <input type="number" id="currentIncome" step="100" min="0" placeholder="0"
                            class="with-unit input-no-border" style="width: 120px;">
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; min-width: 180px;">
                    <label for="inflationRate" style="margin-bottom: 4px; font-weight: 500;">Inflation Rate</label>
                    <div class="input-row">
                        <input type="number" id="inflationRate" step="0.1" min="0" placeholder="0"
                            class="with-unit input-no-border" style="width: 80px;">
                        <span class="input-unit input-unit-right">%</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="full-width" style="margin-bottom: 16px;">
            <div class="portfolio-setup">
                <h2 style="margin-bottom:16px;">ðŸ“Š Portfolio Setup</h2>
                <div class="input-group">
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="totalInvestment" style="display: flex; align-items: center;">
                            Starting Investment
                        </label>
                        <div class="input-row">
                            <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                            <input type="text" id="totalInvestment" step="100" min="0" placeholder="0"
                                class="with-unit input-no-border" data-unit="$">
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="targetAmount" style="display: flex; align-items: center;">
                            Target Amount
                        </label>
                        <div class="input-row">
                            <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                            <input type="text" id="targetAmount" step="100" min="0" placeholder="0"
                                class="with-unit input-no-border">
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; position: relative;">
                        <label for="distributionFreq" style="display: flex; align-items: center;">
                            Distribution Frequency
                        </label>
                        <div class="input-row">
                            <select id="distributionFreq"
                                style="flex:1; background: transparent; border: none; color: #fff; font-size: 1.15rem; font-weight: 500; height: 56px; outline: none;"
                                class="input-no-border">
                                <option value="52">Weekly (52x/year)</option>
                                <option value="26">Bi-weekly (26x/year)</option>
                                <option value="12" selected>Monthly (12x/year)</option>
                                <option value="4">Quarterly (4x/year)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="full-width" style="margin-bottom: 16px;">
            <div class="portfolio-positions">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <h2 style="margin: 0;">ðŸ“ˆ Portfolio Positions</h2>
                    <button class="add-position-text-btn" onclick="openAddPositionModal()" type="button">+ Add New
                        Position
                    </button>
                </div>
                <div id="allocationError" class="error-message" style="display: none;"></div>
                <table class="portfolio-table" id="portfolioTable">
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Allocation %</th>
                            <th>Amount</th>
                            <th>Yield %</th>
                            <th>Annual Income</th>
                            <th>Weekly Income</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioBody">
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Integration Grid Toggle Switch -->
        <div class="card"
            style="width:100%; display:flex;align-items: center; justify-content:space-between; margin-bottom:16px;">
            <h2>Additional Wealth Inputs</h2>
            <div style="display: flex; align-items: center;">
                <label class="toggle-switch" id="integrationToggleLabel">
                    <input type="checkbox" id="toggleIntegrationGridSwitch" checked>
                    <span class="slider"></span>
                </label>
                <span id="toggleIntegrationGridText"
                    style="margin-left:12px; color:#fff; font-weight:400; font-size:.95rem;margin-bottom:8px;">Hide
                    Integrations</span>
            </div>
        </div>

        <div id="integrationGridContainer" style="width: 100%;">
            <div class="integration-grid" style="display: flex; gap: 32px; width: 100;">
                <div class="card iul-integration">
                    <h2>ðŸ’° IUL Integration</h2>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulPremium">Monthly IUL Premium</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="number" id="iulPremium" step="50" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('iulPremium', 50)" viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('iulPremium', -50)" viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulCashValue">Current Cash Value</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="iulCashValue" step="100" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('iulCashValue', 100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('iulCashValue', -100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="iulGrowthRate">Expected Growth Rate</label>
                            <div class="input-row">
                                <input type="number" id="iulGrowthRate" step="0.5" min="0" placeholder="0"
                                    class="with-unit">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('iulGrowthRate', 0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('iulGrowthRate', -0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="reinvestToIUL">Reinvest Dividend %</label>
                            <div class="input-row">
                                <input type="number" id="reinvestToIUL" step="5" min="0" max="100" placeholder="0"
                                    class="with-unit">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('reinvestToIUL', 5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('reinvestToIUL', -5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card bitcoin-integration">
                    <h2>â‚¿ Bitcoin Integration</h2>
                    <div class="input-group">
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinAmountBTC">Current Bitcoin Amount (BTC)</label>
                            <div class="input-row">
                                <input type="number" id="bitcoinAmountBTC" step="0.001" min="0" placeholder="0"
                                    class="with-unit input-no-border" data-unit="BTC">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinAmountBTC', 0.001)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinAmountBTC', -0.001)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinPriceUSD">Current Bitcoin Price</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="text" id="bitcoinPriceUSD" step="100" min="0" placeholder="0"
                                    class="with-unit input-no-border" data-unit="$">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinPriceUSD', 100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinPriceUSD', -100)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinCAGR">Bitcoin CAGR (%)</label>
                            <div class="input-row">
                                <input type="number" id="bitcoinCAGR" step="0.5" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinCAGR', 0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinCAGR', -0.5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="bitcoinMonthlySavingsUSD">Monthly Bitcoin Savings</label>
                            <div class="input-row">
                                <span class="input-unit input-unit-left" aria-hidden="true">$</span>
                                <input type="number" id="bitcoinMonthlySavingsUSD" step="1" min="0" placeholder="0"
                                    class="with-unit input-no-border">
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('bitcoinMonthlySavingsUSD', 1)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('bitcoinMonthlySavingsUSD', -1)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; position: relative;">
                            <label for="reinvestToBitcoin">Reinvest Dividend %</label>
                            <div class="input-row">
                                <input type="number" id="reinvestToBitcoin" step="5" min="0" max="100" placeholder="0"
                                    class="with-unit input-no-border">
                                <span class="input-unit input-unit-right">%</span>
                                <div class="input-arrows">
                                    <svg class="input-arrow" onclick="stepInput('reinvestToBitcoin', 5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 8l-6 6h12z" />
                                    </svg>
                                    <svg class="input-arrow" onclick="stepInput('reinvestToBitcoin', -5)"
                                        viewBox="0 0 24 24">
                                        <path d="M12 16l6-6H6z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10-Year Annualized Projection Table Section -->
        <div class="projection-chart card full-width" style="height:auto;padding-bottom: 48px; margin-top: 32px;" id="tenYearProjectionTableContainer">
            <h2>ðŸ“… 10-Year Annualized Projection Table</h2>
            <div class="table-scroll">
                <table class="projection-table" id="tenYearProjectionTable" style="width: 100%; max-width: 1280px;">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Portfolio Value</th>
                            <th>Annual Dividends</th>
                            <th>IUL Value</th>
                            <th>Bitcoin Value</th>
                            <th>Total Wealth</th>
                            <th>Inflated Income</th>
                        </tr>
                    </thead>
                    <tbody id="tenYearProjectionBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="projection-chart card full-width" style="height:auto;padding-bottom: 48px" id="projectionTableContainer">
            <h2>ðŸ“Š Monthly Growth Projection</h2>
            <div class="table-scroll">
                <table class="projection-table" id="projectionTable" style="width: 100%; max-width: 1280px;">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Portfolio Value</th>
                            <th>Monthly Dividends</th>
                            <th>IUL Value</th>
                            <th>Bitcoin Value</th>
                            <th>Total Wealth</th>
                        </tr>
                    </thead>
                    <tbody id="projectionBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add floating calculate button -->
    <div class="floating-btn-container">
        <div class="button-group">
            <button class="btn-green" onclick="calculateResults()">Calculate Strategy</button>
            <button class="projection-btn" onclick="scrollToProjection()">See Growth Chart</button>
        </div>
    </div>

    <div class="modal" id="addPositionModal">
        <div class="modal-content">
            <h3>Add New Position</h3>
            <div class="input-group">
                <div style="display: flex; flex-direction: column;">
                    <label for="modalTicker">Ticker Symbol</label>
                    <input type="text" id="modalTicker" placeholder="e.g., AAPL" class="input-row">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="modalAllocation">Allocation (%)</label>
                    <input type="number" id="modalAllocation" step="0.1" min="0" placeholder="e.g., 25"
                        class="input-row">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label for="modalYield">Yield (%)</label>
                    <input type="number" id="modalYield" step="0.1" min="0" placeholder="e.g., 5" class="input-row">
                </div>
            </div>
            <div id="modalError" class="error-message" style="display: none;"></div>
            <button class="btn" id="modalSubmitBtn" onclick="submitNewPosition()">Add Position</button>
            <button class="close-btn" onclick="closeAddPositionModal()">Cancel</button>
        </div>
    </div>

    <script>
        let positions = [];
        let positionCounter = 0;
        let wealthChart = null;
        let editingPositionId = null; // Track which position is being edited

        // Save all inputs and positions to localStorage
        function saveState() {
            const inputs = [
                'totalInvestment', 'targetAmount', 'distributionFreq',
                'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL',
                'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin'
            ];
            const state = {};
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    state[id] = el.value.replace(/,/g, '');
                }
            });
            state.positions = positions;
            localStorage.setItem('dripStrategyState', JSON.stringify(state));
        }

        // Restore all inputs and positions from localStorage
        function restoreState() {
            const state = JSON.parse(localStorage.getItem('dripStrategyState') || '{}');
            const inputs = [
                'totalInvestment', 'targetAmount', 'distributionFreq',
                'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL',
                'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin'
            ];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el && state[id] !== undefined) {
                    if (el.type === 'text' && !isNaN(parseFloat(state[id]))) {
                        el.value = parseFloat(state[id]).toLocaleString('en-US');
                    } else {
                        el.value = state[id];
                    }
                }
            });
            if (Array.isArray(state.positions)) {
                positions = state.positions;
                positionCounter = positions.length > 0 ? Math.max(...positions.map(p => p.id)) + 1 : 0;
            }
            updatePortfolioDisplay();
        }

        function initializeDefaultPositions() {
            positions = [];
            positionCounter = 0;
            updatePortfolioDisplay();
        }

        function openAddPositionModal(editId = null) {
            document.getElementById('addPositionModal').style.display = 'flex';
            document.getElementById('modalError').style.display = 'none';
            editingPositionId = editId;
            const submitBtn = document.getElementById('modalSubmitBtn');
            if (editId !== null) {
                const pos = positions.find(p => p.id === editId);
                if (pos) {
                    document.getElementById('modalTicker').value = pos.ticker;
                    document.getElementById('modalAllocation').value = pos.allocation;
                    document.getElementById('modalYield').value = pos.yield;
                }
                submitBtn.textContent = 'Update Position';
            } else {
                document.getElementById('modalTicker').value = '';
                document.getElementById('modalAllocation').value = '';
                document.getElementById('modalYield').value = '';
                submitBtn.textContent = 'Add Position';
            }
        }

        function closeAddPositionModal() {
            document.getElementById('addPositionModal').style.display = 'none';
        }

        function submitNewPosition() {
            const ticker = document.getElementById('modalTicker').value.trim().toUpperCase();
            const allocation = parseFloat(document.getElementById('modalAllocation').value);
            const yieldRate = parseFloat(document.getElementById('modalYield').value);
            if (!ticker || isNaN(allocation) || isNaN(yieldRate) || allocation <= 0 || yieldRate < 0) {
                document.getElementById('modalError').textContent = 'Please enter valid values for all fields.';
                document.getElementById('modalError').style.display = 'block';
                return;
            }
            if (editingPositionId !== null) {
                const pos = positions.find(p => p.id === editingPositionId);
                if (pos) {
                    pos.ticker = ticker;
                    pos.allocation = allocation;
                    pos.yield = yieldRate;
                }
                editingPositionId = null;
            } else {
                const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0) + allocation;
                if (totalAllocation > 100) {
                    document.getElementById('modalError').textContent = 'Total allocation exceeds 100%.';
                    document.getElementById('modalError').style.display = 'block';
                    return;
                }
                positions.push({
                    id: positionCounter++,
                    ticker: ticker,
                    allocation: allocation,
                    yield: yieldRate
                });
            }
            saveState();
            updatePortfolioDisplay();
            closeAddPositionModal();
        }

        function removePosition(id) {
            positions = positions.filter(pos => pos.id !== id);
            saveState();
            updatePortfolioDisplay();
        }

        function updatePortfolioDisplay() {
            const tbody = document.getElementById('portfolioBody');
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            const freqSelect = document.getElementById('distributionFreq');
            const freqValue = parseInt(freqSelect.value, 10);
            const selectedOption = freqSelect.options[freqSelect.selectedIndex].text;
            let freqLabel = selectedOption.split(' ')[0] + ' Income';
            const ths = document.querySelectorAll('#portfolioTable thead th');
            if (ths.length >= 6) {
                ths[5].textContent = freqLabel;
            }
            const allocationError = document.getElementById('allocationError');
            if (totalAllocation > 100) {
                allocationError.textContent = `Total allocation (${totalAllocation.toFixed(1)}%) exceeds 100%. Please adjust.`;
                allocationError.style.display = 'block';
            } else {
                allocationError.style.display = 'none';
            }
            tbody.innerHTML = '';
            positions.forEach(position => {
                const amount = (totalInvestment * position.allocation / 100);
                const annualIncome = (amount * position.yield / 100);
                let freqIncome = annualIncome / freqValue;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${position.ticker}</td>
                    <td>${position.allocation}%</td>
                    <td>$${amount.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>${position.yield}%</td>
                    <td>$${annualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${freqIncome.toLocaleString('en-US', { maximumFractionDigits: 2 })}</td>
                    <td>
                        <button class="edit-btn" onclick="openAddPositionModal(${position.id})">Edit</button>
                        <button class="remove-btn" onclick="removePosition(${position.id})">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            // After updating the table, also update the results card
            calculateResults();
        }

        // --- START OF FIXED AND RESTORED FUNCTIONS ---
        function calculateResults() {
            // Calculate blended yield as the weighted average of portfolio positions
            let totalWeightedYield = 0;
            let allocationSum = 0;
            let totalWeeklyIncome = 0;
            positions.forEach(position => {
                const alloc = parseFloat(position.allocation) || 0;
                const yld = parseFloat(position.yield) || 0;
                totalWeightedYield += alloc * yld;
                allocationSum += alloc;
                // Calculate weekly income for each position
                const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
                const amount = totalInvestment * alloc / 100;
                const annualIncome = amount * yld / 100;
                totalWeeklyIncome += annualIncome / 52;
            });
            const blendedYield = allocationSum > 0 ? totalWeightedYield / allocationSum : 0;
            // Defensive: ensure DOM element exists before updating
            const blendedYieldEl = document.getElementById('blendedYield');
            if (blendedYieldEl) {
                blendedYieldEl.textContent = blendedYield.toFixed(2) + '%';
            }
            const incomeValueEl = document.getElementById('incomeValue');
            const incomeLabelEl = document.getElementById('incomeLabel');
            if (incomeValueEl && incomeLabelEl) {
                incomeLabelEl.textContent = 'Weekly Income';
                incomeValueEl.textContent = '$' + totalWeeklyIncome.toLocaleString('en-US', { maximumFractionDigits: 2 });
            }
            const annualIncomeEl = document.getElementById('annualIncome');
            if (annualIncomeEl) {
                // Sum annual income from all positions
                let totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
                let totalAnnualIncome = positions.reduce((sum, pos) => {
                    const alloc = parseFloat(pos.allocation) || 0;
                    const yld = parseFloat(pos.yield) || 0;
                    const amount = totalInvestment * alloc / 100;
                    return sum + (amount * yld / 100);
                }, 0);
                annualIncomeEl.textContent = '$' + totalAnnualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 });
            }
            const timeToTargetEl = document.getElementById('timeToTarget');
            if (timeToTargetEl) {
                // Use monthly projection for time to target
                const projectionResults = generateAndRenderProjections();
                const timeToTargetMonths = projectionResults.timeToTarget !== 'N/A' ? projectionResults.timeToTarget : 'N/A';
                timeToTargetEl.textContent = timeToTargetMonths !== 'N/A' ? `${timeToTargetMonths} months` : 'N/A';
            }
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value.replace(/,/g, '')) || 0;
            const reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
            const reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;
            if (totalInvestment <= 0) {
                document.getElementById('blendedYield').textContent = '0%';
                document.getElementById('incomeValue').textContent = '$0';
                document.getElementById('annualIncome').textContent = '$0';
                document.getElementById('timeToTarget').textContent = 'N/A';
                return;
            }
            if (targetAmount <= 0 || positions.length === 0) {
                document.getElementById('blendedYield').textContent = '0%';
                document.getElementById('incomeValue').textContent = '$0';
                document.getElementById('annualIncome').textContent = '$0';
                document.getElementById('timeToTarget').textContent = 'N/A';
                return;
            }
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            if (totalAllocation > 100) {
                document.getElementById('blendedYield').textContent = '0%';
                document.getElementById('incomeValue').textContent = '$0';
                document.getElementById('annualIncome').textContent = '$0';
                document.getElementById('timeToTarget').textContent = 'N/A';
                return;
            }
            if (reinvestToIUL + reinvestToBitcoin > 100) {
                document.getElementById('blendedYield').textContent = '0%';
                document.getElementById('incomeValue').textContent = '$0';
                document.getElementById('annualIncome').textContent = '$0';
                document.getElementById('timeToTarget').textContent = 'N/A';
                return;
            }
            const annualIncome = totalInvestment * blendedYield / 100;
            const freqSelect = document.getElementById('distributionFreq');
            const freqValue = parseInt(freqSelect.value, 10);
            const incomeValue = annualIncome / freqValue;
            const incomeLabel = freqSelect.options[freqSelect.selectedIndex].text.split(' ')[0] + ' Income';
            // Calculate time to target using monthly projection
            const projectionResults = generateAndRenderProjections();
            generateAndRenderAnnualProjections();
            generateAndRenderTenYearProjection();
            // Defensive: ensure DOM elements exist before updating
            if (!incomeValueEl || !annualIncomeEl || !timeToTargetEl || !incomeLabelEl) return;
            incomeLabelEl.textContent = incomeLabel;
            incomeValueEl.textContent = '$' + incomeValue.toLocaleString('en-US', { maximumFractionDigits: 2 });
            annualIncomeEl.textContent = '$' + annualIncome.toLocaleString('en-US', { maximumFractionDigits: 0 });
            timeToTargetEl.textContent = projectionResults.timeToTarget !== 'N/A' ? `${projectionResults.timeToTarget} months` : 'N/A';
            document.getElementById('projectionChartContainer').style.display = 'block';
            renderChart(projectionResults.chartData);
            saveState();
        }

        function generateAndRenderProjections() {
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value.replace(/,/g, '')) || 0;
            const iulPremium = parseFloat(document.getElementById('iulPremium').value) || 0;
            const iulCashValue = parseFloat(document.getElementById('iulCashValue').value.replace(/,/g, '')) || 0;
            const iulGrowthRate = parseFloat(document.getElementById('iulGrowthRate').value) || 0;
            const reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
            const bitcoinAmountBTC = parseFloat(document.getElementById('bitcoinAmountBTC').value) || 0;
            const initialBitcoinPriceUSD = parseFloat(document.getElementById('bitcoinPriceUSD').value.replace(/,/g, '')) || 0;
            const bitcoinCAGR = parseFloat(document.getElementById('bitcoinCAGR').value) || 0;
            const bitcoinMonthlySavingsUSD = parseFloat(document.getElementById('bitcoinMonthlySavingsUSD').value) || 0;
            const reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;
            let totalWeightedYield = 0;
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            positions.forEach(position => {
                totalWeightedYield += position.allocation * position.yield;
            });
            const blendedYield = totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;
            const monthlyYield = blendedYield / 100 / 12;
            const monthlyIULGrowth = iulGrowthRate / 100 / 12;
            const monthlyBitcoinGrowth = Math.pow(1 + bitcoinCAGR / 100, 1 / 12) - 1;
            let portfolioValue = totalInvestment;
            let currentIULValue = iulCashValue;
            let currentBitcoinAmountBTC = bitcoinAmountBTC;
            let currentBitcoinPriceUSD = initialBitcoinPriceUSD;
            const tbody = document.getElementById('projectionBody');
            tbody.innerHTML = '';
            const chartData = { labels: [], portfolio: [], iul: [], bitcoin: [], total: [] };
            let timeToTarget = 'N/A';
            let targetReached = false;
            for (let month = 0; month <= 600; month++) {
                const monthlyDividends = portfolioValue * monthlyYield;
                const toIUL = monthlyDividends * (reinvestToIUL / 100);
                const toBitcoin = monthlyDividends * (reinvestToBitcoin / 100);
                const toDRIP = monthlyDividends - toIUL - toBitcoin;
                if (month > 0) {
                    portfolioValue += toDRIP;
                    currentIULValue = (currentIULValue + iulPremium + toIUL) * (1 + monthlyIULGrowth);
                    if (currentBitcoinPriceUSD > 0) {
                        currentBitcoinAmountBTC += (bitcoinMonthlySavingsUSD + toBitcoin) / currentBitcoinPriceUSD;
                    }
                    currentBitcoinPriceUSD *= (1 + monthlyBitcoinGrowth);
                }
                const currentBitcoinValueUSD = currentBitcoinAmountBTC * currentBitcoinPriceUSD;
                const totalWealth = portfolioValue + currentIULValue + currentBitcoinValueUSD;
                if (totalWealth >= targetAmount && !targetReached) {
                    timeToTarget = month;
                    targetReached = true;
                }
                if (month <= 36) {
                    const row = document.createElement('tr');
                    if (month === timeToTarget) {
                        row.className = 'highlight';
                    }
                    row.innerHTML = `
                        <td>${month}</td>
                        <td>$${portfolioValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${monthlyDividends.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${currentIULValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${currentBitcoinValueUSD.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                        <td>$${totalWealth.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    `;
                    tbody.appendChild(row);
                }
                chartData.labels.push(`M ${month}`);
                chartData.portfolio.push(portfolioValue);
                chartData.iul.push(currentIULValue);
                chartData.bitcoin.push(currentBitcoinValueUSD);
                chartData.total.push(totalWealth);
                if (month > 60 && targetReached) {
                    break;
                }
            }
            return { timeToTarget, chartData };
        }

        function generateAndRenderAnnualProjections() {
            const totalInvestment = parseFloat(document.getElementById('totalInvestment').value.replace(/,/g, '')) || 0;
            const targetAmount = parseFloat(document.getElementById('targetAmount').value.replace(/,/g, '')) || 0;
            const iulPremium = parseFloat(document.getElementById('iulPremium').value) || 0;
            const iulCashValue = parseFloat(document.getElementById('iulCashValue').value.replace(/,/g, '')) || 0;
            const iulGrowthRate = parseFloat(document.getElementById('iulGrowthRate').value) || 0;
            const reinvestToIUL = parseFloat(document.getElementById('reinvestToIUL').value) || 0;
            const bitcoinAmountBTC = parseFloat(document.getElementById('bitcoinAmountBTC').value) || 0;
            const initialBitcoinPriceUSD = parseFloat(document.getElementById('bitcoinPriceUSD').value.replace(/,/g, '')) || 0;
            const bitcoinCAGR = parseFloat(document.getElementById('bitcoinCAGR').value) || 0;
            const bitcoinMonthlySavingsUSD = parseFloat(document.getElementById('bitcoinMonthlySavingsUSD').value) || 0;
            const reinvestToBitcoin = parseFloat(document.getElementById('reinvestToBitcoin').value) || 0;
            const inflationRate = parseFloat(document.getElementById('inflationRate').value) || 0;
            const currentIncome = parseFloat(document.getElementById('currentIncome').value.replace(/,/g, '')) || 0;
            let totalWeightedYield = 0;
            const totalAllocation = positions.reduce((sum, pos) => sum + pos.allocation, 0);
            positions.forEach(position => {
                totalWeightedYield += position.allocation * position.yield;
            });
            const blendedYield = totalAllocation > 0 ? totalWeightedYield / totalAllocation : 0;
            const monthlyYield = blendedYield / 100 / 12;
            const monthlyIULGrowth = iulGrowthRate / 100 / 12;
            const monthlyBitcoinGrowth = Math.pow(1 + bitcoinCAGR / 100, 1 / 12) - 1;
            let portfolioValue = totalInvestment;
            let currentIULValue = iulCashValue;
            let currentBitcoinAmountBTC = bitcoinAmountBTC;
            let currentBitcoinPriceUSD = initialBitcoinPriceUSD;
            let annualRows = [];
            let chartData = { labels: [], portfolio: [], iul: [], bitcoin: [], total: [], inflatedIncome: [] };
            let timeToTarget = 'N/A';
            let targetReached = false;
            let month = 0;
            let annualDividends = 0;
            let annualInflatedIncome = currentIncome;
            for (let year = 1; year <= 10; year++) {
                let yearPortfolioValue = portfolioValue;
                let yearIULValue = currentIULValue;
                let yearBitcoinValue = currentBitcoinAmountBTC * currentBitcoinPriceUSD;
                let yearTotalWealth = yearPortfolioValue + yearIULValue + yearBitcoinValue;
                let yearDividends = 0;
                for (let m = 0; m < 12; m++, month++) {
                    const monthlyDividends = portfolioValue * monthlyYield;
                    yearDividends += monthlyDividends;
                    const toIUL = monthlyDividends * (reinvestToIUL / 100);
                    const toBitcoin = monthlyDividends * (reinvestToBitcoin / 100);
                    const toDRIP = monthlyDividends - toIUL - toBitcoin;
                    portfolioValue += toDRIP;
                    currentIULValue = (currentIULValue + iulPremium + toIUL) * (1 + monthlyIULGrowth);
                    if (currentBitcoinPriceUSD > 0) {
                        currentBitcoinAmountBTC += (bitcoinMonthlySavingsUSD + toBitcoin) / currentBitcoinPriceUSD;
                    }
                    currentBitcoinPriceUSD *= (1 + monthlyBitcoinGrowth);
                    yearPortfolioValue = portfolioValue;
                    yearIULValue = currentIULValue;
                    yearBitcoinValue = currentBitcoinAmountBTC * currentBitcoinPriceUSD;
                    yearTotalWealth = yearPortfolioValue + yearIULValue + yearBitcoinValue;
                    if (yearTotalWealth >= targetAmount && !targetReached) {
                        timeToTarget = `${year} yr ${m+1} mo`;
                        targetReached = true;
                    }
                }
                annualInflatedIncome = currentIncome * Math.pow(1 + inflationRate / 100, year);
                annualRows.push({
                    year,
                    portfolioValue: yearPortfolioValue,
                    annualDividends: yearDividends,
                    iulValue: yearIULValue,
                    bitcoinValue: yearBitcoinValue,
                    totalWealth: yearTotalWealth,
                    inflatedIncome: annualInflatedIncome
                });
                chartData.labels.push(`Year ${year}`);
                chartData.portfolio.push(yearPortfolioValue);
                chartData.iul.push(yearIULValue);
                chartData.bitcoin.push(yearBitcoinValue);
                chartData.total.push(yearTotalWealth);
                chartData.inflatedIncome.push(annualInflatedIncome);
            }
            // Render table
            const tableContainer = document.getElementById('tenYearProjectionTableContainer');
            let table = document.getElementById('tenYearProjectionTable');
            if (!table) {
                table = document.createElement('table');
                table.className = 'projection-table';
                table.id = 'tenYearProjectionTable';
                table.style = 'width: 100%; max-width: 1280px;';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Portfolio Value</th>
                            <th>Annual Dividends</th>
                            <th>IUL Value</th>
                            <th>Bitcoin Value</th>
                            <th>Total Wealth</th>
                            <th>Inflated Income</th>
                        </tr>
                    </thead>
                    <tbody id="tenYearProjectionBody"></tbody>
                `;
                tableContainer.appendChild(table);
            }
            const tbody = document.getElementById('tenYearProjectionBody');
            tbody.innerHTML = '';
            annualRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.year}</td>
                    <td>$${row.portfolioValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${row.annualDividends.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${row.iulValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${row.bitcoinValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${row.totalWealth.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                    <td>$${row.inflatedIncome.toLocaleString('en-US', { maximumFractionDigits: 0 })}</td>
                `;
                tbody.appendChild(tr);
            });
            renderAnnualChart(chartData);
            return { timeToTarget, chartData };
        }

        let annualWealthChart = null;
        function renderAnnualChart(chartData) {
            if (annualWealthChart) {
                annualWealthChart.destroy();
            }
            const ctx = document.getElementById('annualWealthChart').getContext('2d');
            annualWealthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Portfolio Value',
                            data: chartData.portfolio,
                            borderColor: '#10B981',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'IUL Cash Value',
                            data: chartData.iul,
                            borderColor: '#3B82F6',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Bitcoin Value (USD)',
                            data: chartData.bitcoin,
                            borderColor: '#8B5CF6',
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Total Wealth',
                            data: chartData.total,
                            borderColor: '#F5A623',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Inflated Income',
                            data: chartData.inflatedIncome,
                            borderColor: '#EF4444',
                            borderDash: [5,5],
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E5E7EB',
                                callback: value => '$' + value.toLocaleString()
                            },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        },
                        x: {
                            ticks: { color: '#E5E7EB' },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#E5E7EB' } }
                    }
                }
            });
        }

        function renderChart(chartData) {
            if (wealthChart) {
                wealthChart.destroy();
            }
            const ctx = document.getElementById('wealthChart').getContext('2d');
            wealthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Portfolio Value',
                        data: chartData.portfolio,
                        borderColor: '#10B981',
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'IUL Cash Value',
                        data: chartData.iul,
                        borderColor: '#3B82F6',
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Bitcoin Value (USD)',
                        data: chartData.bitcoin,
                        borderColor: '#8B5CF6',
                        fill: false,
                        tension: 0.1
                    }, {
                        label: 'Total Wealth',
                        data: chartData.total,
                        borderColor: '#F5A623',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#E5E7EB',
                                callback: value => '$' + value.toLocaleString()
                            },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        },
                        x: {
                            ticks: { color: '#E5E7EB' },
                            grid: { color: 'rgba(255,255,255,0.07)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#E5E7EB' } }
                    }
                }
            });
        }

        function scrollToProjection() {
            document.getElementById('projectionChartContainer').scrollIntoView({
                behavior: 'smooth'
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('dripStrategyState')) {
                restoreState();
            } else {
                initializeDefaultPositions();
            }
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const originalValue = e.target.value;
                    const numericValue = parseFloat(originalValue.replace(/,/g, ''));
                    if (!isNaN(numericValue) && originalValue.slice(-1) !== '.') {
                        e.target.value = numericValue.toLocaleString('en-US');
                    }
                    calculateResults(); // Update results immediately on input
                });
                input.addEventListener('blur', saveState);
            });
            document.querySelectorAll('input[type="number"], select').forEach(input => {
                input.addEventListener('change', function() {
                    saveState();
                    calculateResults(); // Update results immediately on change
                });
            });
            attachResultsListeners(); // <-- Ensure results update on input change
            calculateResults(); // <-- Initial calculation on load
            const toggleSwitch = document.getElementById('toggleIntegrationGridSwitch');
            toggleSwitch.addEventListener('change', function() {
                const container = document.getElementById('integrationGridContainer');
                const label = document.getElementById('toggleIntegrationGridText');
                if (this.checked) {
                    container.style.display = 'block';
                    label.textContent = "Hide Integrations";
                } else {
                    container.style.display = 'none';
                    label.textContent = "Show Integrations";
                }
                calculateResults(); // Update results when integrations are toggled
            });
        });

        function attachResultsListeners() {
            const inputIds = [
                'totalInvestment', 'targetAmount', 'distributionFreq',
                'iulPremium', 'iulCashValue', 'iulGrowthRate', 'reinvestToIUL',
                'bitcoinAmountBTC', 'bitcoinPriceUSD', 'bitcoinCAGR', 'bitcoinMonthlySavingsUSD', 'reinvestToBitcoin',
                'inflationRate', 'currentIncome'
            ];
            inputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', function() {
                        calculateResults();
                    });
                    el.addEventListener('change', function() {
                        calculateResults();
                    });
                }
            });
            document.getElementById('distributionFreq').addEventListener('change', calculateResults);
        }
    </script>
</body>

</html>